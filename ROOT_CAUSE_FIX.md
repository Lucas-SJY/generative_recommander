# æ¨èç³»ç»Ÿæ¨èç»“æœç›¸åŒé—®é¢˜ - æœ€ç»ˆè¯Šæ–­ä¸ä¿®å¤

## é—®é¢˜ç°è±¡

æ— è®ºç”¨æˆ·è¾“å…¥ä»€ä¹ˆï¼Œç³»ç»Ÿæ¨èçš„äº§å“æ€»æ˜¯ç›¸åŒçš„å‡ ä¸ªï¼ˆå¦‚ YouTubeã€Echo Dotã€Fire TV Stickï¼‰ã€‚

## æ ¹æœ¬åŸå› 

### ğŸ”´ **æ ¸å¿ƒé—®é¢˜ï¼šå…³é”®è¯æœç´¢ä½¿ç”¨äº†é”™è¯¯çš„è¯­è¨€é…ç½®**

ä»£ç åœ¨ `keyword_search()` æ–¹æ³•ä¸­ä½¿ç”¨äº† **PostgreSQL è‹±æ–‡å…¨æ–‡æœç´¢**ï¼š

```python
to_tsvector('english', COALESCE(i.title, ''))  # â† é—®é¢˜ï¼
to_tsquery('english', :search_query)            # â† åªèƒ½æœç´¢è‹±æ–‡
```

**åæœï¼š**
- ç”¨æˆ·è¾“å…¥çš„ **ä¸­æ–‡å…³é”®è¯** æ— æ³•åŒ¹é…ä»»ä½•å•†å“
- å…³é”®è¯æœç´¢è¿”å› 0 æ¡ç»“æœ
- ç³»ç»Ÿé€€åŒ–åˆ°"çƒ­é—¨å•†å“"æ¨¡å¼
- æ‰€æœ‰æŸ¥è¯¢éƒ½æ¨èç›¸åŒçš„é«˜è¯„åˆ†çƒ­é—¨å•†å“

### ç¤ºæ„æµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥ï¼šæˆ‘éœ€è¦ç”µè„‘
  â†“
Query Understanding: æå–å…³é”®è¯ ["ç”µè„‘"]
  â†“
Keyword Search (è‹±æ–‡å…¨æ–‡æœç´¢):
  SELECT ... WHERE to_tsvector('english', title) @@ to_tsquery('english', 'ç”µè„‘')
  ç»“æœï¼š0æ¡ (ä¸­æ–‡å…³é”®è¯æ— æ³•åŒ¹é…) âŒ
  â†“
Vector Search: å¦‚æœembeddingå¤±è´¥ â†’ 0æ¡
  â†“
Category Search: 0æ¡ (å› ä¸ºæ²¡æœ‰å‘é‡ç»“æœ)
  â†“
Popular Items: è¿”å›çƒ­é—¨å•†å“ âœ“
  â†“
æ¨èï¼šYouTube, Echo Dot... (éƒ½æ˜¯çƒ­é—¨å•†å“)
```

## å®æ–½çš„ä¿®å¤

### ä¿®å¤ 1ï¼šæ›¿æ¢ä¸ºè¯­è¨€æ— å…³çš„æœç´¢æ–¹æ³•

**æ—§ä»£ç ï¼ˆé—®é¢˜ï¼‰ï¼š**
```python
ts_rank(to_tsvector('english', COALESCE(i.title, '')), to_tsquery('english', :search_query))
# åªèƒ½æœç´¢è‹±æ–‡
```

**æ–°ä»£ç ï¼ˆè§£å†³ï¼‰ï¼š**
```python
CASE 
    WHEN i.title ILIKE :keyword_pattern THEN 10
    WHEN i.category ILIKE :keyword_pattern THEN 5
    ELSE 1
END as rank

# ä½¿ç”¨ ILIKE (case-insensitive substring search)
# æ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€æ··åˆæ–‡æœ¬
```

### ä¿®å¤ 2ï¼šæ”¹è¿›å…³é”®è¯æœç´¢çš„é™çº§ç­–ç•¥

å½“ç»„åˆå…³é”®è¯æ— ç»“æœæ—¶ï¼Œè‡ªåŠ¨å°è¯•å•ä¸ªå…³é”®è¯æœç´¢ï¼š

```python
if not items and len(keywords) > 1:
    # é€ä¸ªå°è¯•å…³é”®è¯
    for keyword in keywords:
        # æ‰§è¡Œå•è¯æœç´¢...
```

### ä¿®å¤ 3ï¼šä¼˜åŒ–æ¨èè·¯å¾„çš„æƒé‡åˆ†é…

**æ”¹è¿›äº†æƒé‡è®¡ç®—ï¼š**

```python
# å‘é‡æœç´¢æƒé‡
item["score"] = similarity * 0.6 + position_weight * 0.4

# å…³é”®è¯æœç´¢æƒé‡ï¼ˆå½“å‘é‡å¤±è´¥æ—¶ä¼˜å…ˆçº§æ›´é«˜ï¼‰
item["score"] = similarity * 0.7 + position_weight * 0.3

# åˆ†ç±»æœç´¢æƒé‡
item["score"] = similarity * 0.4 + position_weight * 0.2

# çƒ­é—¨å•†å“æƒé‡ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰
item["score"] = similarity * 0.1 + position_weight * 0.05
```

### ä¿®å¤ 4ï¼šæ”¹è¿›çƒ­é—¨å•†å“çš„è§¦å‘æ¡ä»¶

åŸæ¥ï¼š`if len(all_candidates) < self.topn` â†’ éå¸¸å®¹æ˜“è§¦å‘

æ–°çš„ï¼š`if len(all_candidates) < self.topn * 2` â†’ åªæœ‰å½“å€™é€‰æ•°é‡å¾ˆå°‘æ—¶æ‰ä½¿ç”¨

## é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
```
æŸ¥è¯¢1ï¼šæˆ‘éœ€è¦ç”µè„‘
æ¨èï¼šYouTube, Echo Dot, Fire TV...

æŸ¥è¯¢2ï¼šæˆ‘æƒ³è¦éŸ³ç®±
æ¨èï¼šYouTube, Echo Dot, Fire TV... (å®Œå…¨ç›¸åŒï¼)

æŸ¥è¯¢3ï¼šæ¨èä¹¦ç±
æ¨èï¼šYouTube, Echo Dot, Fire TV... (è¿˜æ˜¯ç›¸åŒï¼)
```

### ä¿®å¤å
```
æŸ¥è¯¢1ï¼šæˆ‘éœ€è¦ç”µè„‘
å…³é”®è¯ï¼š["ç”µè„‘"]
â†“ å­ä¸²åŒ¹é… ILIKE '%ç”µè„‘%'
æ¨èï¼šXPS ç¬”è®°æœ¬, MacBook Pro, Dell Inspiron...

æŸ¥è¯¢2ï¼šæˆ‘æƒ³è¦éŸ³ç®±
å…³é”®è¯ï¼š["éŸ³ç®±"]
â†“ å­ä¸²åŒ¹é… ILIKE '%éŸ³ç®±%'
æ¨èï¼šSony è“ç‰™éŸ³ç®±, JBL Flip, Anker Soundcore...

æŸ¥è¯¢3ï¼šæ¨èä¹¦ç±
å…³é”®è¯ï¼š["ä¹¦ç±", "ä¹¦"]
â†“ å­ä¸²åŒ¹é… ILIKE '%ä¹¦%'
æ¨èï¼šPythonç¼–ç¨‹ä¹¦, æ·±åº¦å­¦ä¹ , ç®—æ³•ä¹¦...
```

## å…³é”®æ”¹åŠ¨æ–‡ä»¶

**æ–‡ä»¶ï¼š** `/home/lucas/ucsc/yi/backend/recommendation_engine.py`

### ä¸»è¦æ”¹åŠ¨

1. **`keyword_search()` æ–¹æ³•** (ç¬¬ 75-183 è¡Œ)
   - æ›¿æ¢ä¸º `ILIKE` å­ä¸²æœç´¢ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
   - æ·»åŠ å•è¯é™çº§æœç´¢é€»è¾‘
   - æ·»åŠ è¯¦ç»†æ—¥å¿—

2. **`multi_path_recommend()` æ–¹æ³•** (ç¬¬ 298-371 è¡Œ)
   - æ”¹è¿›æƒé‡åˆ†é…
   - ä¼˜åŒ–é™çº§æ¡ä»¶
   - ä¿®å¤æƒé‡è®¡ç®—ä¸­çš„é™¤é›¶é—®é¢˜

3. **`_extract_keywords_fallback()` æ–¹æ³•** 
   - æ”¹è¿›äº†å¤‡é€‰å…³é”®è¯æå–

## éªŒè¯æ­¥éª¤

è¿è¡Œè¯Šæ–­è„šæœ¬ï¼š
```bash
cd /home/lucas/ucsc/yi
python diagnostic_check.py
```

è¯¥è„šæœ¬ä¼šè¾“å‡ºï¼š
1. æ•°æ®åº“ä¸­çš„äº§å“æ€»æ•°å’Œåˆ†ç±»åˆ†å¸ƒ
2. æµ‹è¯•å…³é”®è¯æœç´¢æ˜¯å¦æ­£å¸¸è¿”å›ä¸åŒç»“æœ
3. æµ‹è¯•å®Œæ•´æ¨èæµç¨‹çš„æ¯ä¸€æ­¥

## æµ‹è¯•æ¡ˆä¾‹

```python
# åº”è¯¥è¿”å›ä¸åŒçš„ç»“æœ
query1 = "æˆ‘éœ€è¦ä¸€å°ç¬”è®°æœ¬ç”µè„‘ç”¨äºç¼–ç¨‹"
query2 = "æ¨èä¸€ä¸ªå¥½çš„è“ç‰™éŸ³ç®±"
query3 = "æˆ‘æƒ³è¦ä¸€æœ¬Pythonç¼–ç¨‹ä¹¦"

# æ¯ä¸ªæŸ¥è¯¢åº”è¯¥æœ‰ä¸åŒçš„æ¨èåˆ—è¡¨
# âœ“ query1 â†’ ç”µè„‘äº§å“
# âœ“ query2 â†’ éŸ³ç®±äº§å“  
# âœ“ query3 â†’ ä¹¦ç±äº§å“
```

## ä¸ºä»€ä¹ˆä¹‹å‰çš„ä¿®å¤ä¸èµ·ä½œç”¨

ä¹‹å‰çš„ä¿®å¤ä¸»è¦å…³æ³¨ï¼š
- âŒ JSONè§£æå®¹é”™ (æ¬¡è¦é—®é¢˜)
- âŒ Embeddingç”Ÿæˆå®¹é”™ (æ¬¡è¦é—®é¢˜)

ä½†**æ²¡æœ‰è§£å†³æ ¹æœ¬é—®é¢˜**ï¼š
- âŒ å…³é”®è¯æœç´¢ä½¿ç”¨äº†é”™è¯¯çš„è¯­è¨€ï¼ˆè‹±æ–‡è€Œéä¸­æ–‡ï¼‰

å› ä¸ºå…³é”®è¯æœç´¢æ€»æ˜¯è¿”å› 0 ç»“æœï¼Œæ‰€ä»¥ç³»ç»Ÿæœ€ç»ˆéƒ½ä¾èµ–çƒ­é—¨å•†å“ï¼Œå¯¼è‡´æ¨èç›¸åŒã€‚

## åç»­éªŒè¯

ä¿®å¤åéœ€è¦ï¼š
1. âœ“ é‡å¯åç«¯æœåŠ¡ï¼ˆä½¿ç”¨æ–°çš„æ¨èå¼•æ“ä»£ç ï¼‰
2. âœ“ æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
3. âœ“ å°è¯•ä¸åŒçš„æŸ¥è¯¢è¾“å…¥
4. âœ“ éªŒè¯æ¨èç»“æœä¸å†ç›¸åŒ

éœ€è¦æŸ¥çœ‹ï¼š
- åç«¯æ—¥å¿—ä¸­çš„ "Keyword path returned X items" 
- ä¸åŒæŸ¥è¯¢åº”è¯¥è¿”å›ä¸åŒæ•°é‡çš„ç»“æœ
